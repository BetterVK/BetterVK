"use strict";
console.log("ğŸ”¥ BetterVK Ğ’Ğ¡Ğ¢Ğ ĞĞ•Ğ Ğ’ entryVkm.js!");
const { contextBridge, ipcRenderer } = require("electron");
const path = require("path");
const fs = require("fs");
const crypto = require("crypto");
const https = require("https");
const BETTERVK_DIR = path.join(require("os").homedir(), ".bettervk");
const CORE_SCRIPT = path.join(BETTERVK_DIR, "core.js");
function getFileSHA256(filePath) {
    if (!fs.existsSync(filePath)) return null;
    return crypto.createHash("sha256").update(fs.readFileSync(filePath)).digest("hex");
}

async function getGitHubSHA256(url) {
    return new Promise((resolve) => {
        https.get(url, (response) => {
            if (response.statusCode !== 200) {
                console.error(`âŒ ĞÑˆĞ¸Ğ±ĞºĞ°: ÑĞµÑ€Ğ²ĞµÑ€ Ğ²ĞµÑ€Ğ½ÑƒĞ» ÑÑ‚Ğ°Ñ‚ÑƒÑ ${response.statusCode}`);
                return resolve(null);
            }

            let content = "";
            response.on("data", chunk => content += chunk);
            response.on("end", () => {
                const hash = crypto.createHash("sha256").update(content).digest("hex");
                resolve(hash);
            });
        }).on("error", (err) => {
            console.error("âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ SHA-256:", err.message);
            resolve(null);
        });
    });
}

function downloadBetterVK() {
    console.log("ğŸŒ Ğ¡ĞºĞ°Ñ‡Ğ¸Ğ²Ğ°Ğ½Ğ¸Ğµ `core.js`...");
    if (!fs.existsSync(BETTERVK_DIR)) fs.mkdirSync(BETTERVK_DIR, { recursive: true });

    const file = fs.createWriteStream(CORE_SCRIPT);
    const url = "https://raw.githubusercontent.com/BetterVK/BetterVK/main/bur/core.js";

    return new Promise((resolve) => {
        https.get(url, (response) => {
            if (response.statusCode !== 200) {
                console.error(`âŒ ĞÑˆĞ¸Ğ±ĞºĞ°: ÑĞµÑ€Ğ²ĞµÑ€ Ğ²ĞµÑ€Ğ½ÑƒĞ» ÑÑ‚Ğ°Ñ‚ÑƒÑ ${response.statusCode}`);
                return resolve(false);
            }

            response.pipe(file);
            file.on("finish", () => {
                file.close(() => {
                    console.log("âœ… `core.js` ÑĞºĞ°Ñ‡Ğ°Ğ½!");
                    resolve(true);
                });
            });
        }).on("error", (err) => {
            console.error("âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ `core.js`:", err.message);
            resolve(false);
        });
    });
}

function executeBetterVK() {
    if (fs.existsSync(CORE_SCRIPT)) {
        console.log("âœ… Ğ—Ğ°Ğ¿ÑƒÑĞº `core.js`...");
        const script = fs.readFileSync(CORE_SCRIPT, "utf8");
        window.eval(script);
    } else {
        console.warn("âš ï¸ `core.js` Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½! ĞŸĞµÑ€ĞµÑĞºĞ°Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼...");
        downloadBetterVK().then(() => location.reload());
    }
}

async function checkAndDownloadBetterVK() {
    console.log("ğŸ” ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ SHA-256 `core.js`...");
    const localSHA = getFileSHA256(CORE_SCRIPT);
    const remoteSHA = await getGitHubSHA256("https://raw.githubusercontent.com/BetterVK/BetterVK/main/bur/core.js");

    if (localSHA && remoteSHA) {
        console.log("ğŸ“œ Ğ›Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ SHA-256:", localSHA);
        console.log("ğŸŒ GitHub SHA-256:", remoteSHA);
    }

    if (!localSHA || localSHA !== remoteSHA) {
        console.warn("âš ï¸ Ğ¥ĞµÑˆĞ¸ Ğ½Ğµ ÑĞ¾Ğ²Ğ¿Ğ°Ğ´Ğ°ÑÑ‚! ĞŸĞµÑ€ĞµÑĞºĞ°Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼...");
        await downloadBetterVK();
        location.reload(); // ğŸ”„ ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ
    } else {
        console.log("âœ… `core.js` Ğ°ĞºÑ‚ÑƒĞ°Ğ»ĞµĞ½, Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼...");
        executeBetterVK();
    }
}

window.onload = () => {
    console.log("ğŸš€ Ğ—Ğ°Ğ¿ÑƒÑĞº BetterVK...");
    checkAndDownloadBetterVK();
};

function addBetterVKMenu() {
    let menu = document.createElement("div");
    menu.id = "bettervk-menu";
    menu.style = "position: fixed; top: 10px; right: 10px; background: rgb(25, 25, 26); color: white; padding: 10px; z-index: 9999; border-radius: 5px;";
    menu.innerHTML = `
        <h3>âš™ï¸ BetterVK</h3>
        <button onclick="executeBetterVK()">ğŸ”„ ĞŸĞµÑ€ĞµĞ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ</button>
        <button onclick="location.reload()">â™»ï¸ ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ</button>
    `;
    document.body.appendChild(menu);
}

setTimeout(addBetterVKMenu, 3000);
